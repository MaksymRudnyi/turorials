"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault").default;

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard").default;

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _toConsumableArray2 = _interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));

var _objectSpread2 = _interopRequireDefault(require("@babel/runtime/helpers/objectSpread2"));

var _objectWithoutProperties2 = _interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties"));

var _react = _interopRequireWildcard(require("react"));

var _reactMarkdown = _interopRequireDefault(require("react-markdown"));

var _remarkGfm = _interopRequireDefault(require("remark-gfm"));

var _rehypeSlug = _interopRequireDefault(require("rehype-slug"));

var _rehypeAutolinkHeadings = _interopRequireDefault(require("rehype-autolink-headings"));

var _rehypeRaw = _interopRequireDefault(require("rehype-raw"));

var _rehypeAttr = _interopRequireDefault(require("rehype-attr"));

var _rehypeIgnore = _interopRequireDefault(require("rehype-ignore"));

var _rehypePrismPlus = _interopRequireDefault(require("rehype-prism-plus"));

var _rehypeRewrite = _interopRequireWildcard(require("rehype-rewrite"));

var _octiconLink = require("./nodes/octiconLink");

var _copy = require("./nodes/copy");

var _reservedMeta = require("./plugins/reservedMeta");

var _jsxRuntime = require("react/jsx-runtime");

var _excluded = ["prefixCls", "className", "source", "style", "disableCopy", "onScroll", "onMouseOver", "pluginsFilter", "rehypeRewrite", "warpperElement"];

var _default = /*#__PURE__*/_react.default.forwardRef(function (props, ref) {
  var _props$prefixCls = props.prefixCls,
      prefixCls = _props$prefixCls === void 0 ? 'wmde-markdown wmde-markdown-color' : _props$prefixCls,
      className = props.className,
      source = props.source,
      style = props.style,
      _props$disableCopy = props.disableCopy,
      disableCopy = _props$disableCopy === void 0 ? false : _props$disableCopy,
      onScroll = props.onScroll,
      onMouseOver = props.onMouseOver,
      pluginsFilter = props.pluginsFilter,
      rewrite = props.rehypeRewrite,
      _props$warpperElement = props.warpperElement,
      warpperElement = _props$warpperElement === void 0 ? {} : _props$warpperElement,
      other = (0, _objectWithoutProperties2.default)(props, _excluded);

  var mdp = /*#__PURE__*/_react.default.createRef();

  (0, _react.useImperativeHandle)(ref, function () {
    return (0, _objectSpread2.default)((0, _objectSpread2.default)({}, props), {}, {
      mdp: mdp
    });
  }, [mdp, props]);
  var cls = "".concat(prefixCls || '', " ").concat(className || '');

  var rehypeRewriteHandle = function rehypeRewriteHandle(node, index, parent) {
    if (node.type === 'element' && parent && parent.type === 'root' && /h(1|2|3|4|5|6)/.test(node.tagName)) {
      var child = node.children && node.children[0];

      if (child && child.properties && child.properties.ariaHidden === 'true') {
        child.properties = (0, _objectSpread2.default)({
          class: 'anchor'
        }, child.properties);
        child.children = [_octiconLink.octiconLink];
      }
    }

    if (node.type === 'element' && node.tagName === 'pre' && !disableCopy) {
      var code = (0, _rehypeRewrite.getCodeString)(node.children);
      node.children.push((0, _copy.copyElement)(code));
    }

    rewrite && rewrite(node, index, parent);
  };

  var rehypePlugins = [_reservedMeta.reservedMeta, [_rehypePrismPlus.default, {
    ignoreMissing: true
  }], _rehypeRaw.default, _rehypeSlug.default, _rehypeAutolinkHeadings.default, _rehypeIgnore.default, [_rehypeRewrite.default, {
    rewrite: rehypeRewriteHandle
  }], [_rehypeAttr.default, {
    properties: 'attr'
  }]].concat((0, _toConsumableArray2.default)(other.rehypePlugins || []));
  var customProps = {
    allowElement: function allowElement(element, index, parent) {
      if (other.allowElement) {
        return other.allowElement(element, index, parent);
      }

      return /^[A-Za-z0-9]+$/.test(element.tagName);
    }
  };
  var remarkPlugins = [].concat((0, _toConsumableArray2.default)(other.remarkPlugins || []), [_remarkGfm.default]);
  return /*#__PURE__*/(0, _jsxRuntime.jsx)("div", (0, _objectSpread2.default)((0, _objectSpread2.default)({
    ref: mdp,
    onScroll: onScroll,
    onMouseOver: onMouseOver
  }, warpperElement), {}, {
    className: cls,
    style: style,
    children: /*#__PURE__*/(0, _jsxRuntime.jsx)(_reactMarkdown.default, (0, _objectSpread2.default)((0, _objectSpread2.default)((0, _objectSpread2.default)({}, other), customProps), {}, {
      rehypePlugins: pluginsFilter ? pluginsFilter('rehype', rehypePlugins) : rehypePlugins,
      remarkPlugins: pluginsFilter ? pluginsFilter('remark', remarkPlugins) : remarkPlugins,
      children: source || ''
    }))
  }));
});

exports.default = _default;
module.exports = exports.default;
//# sourceMappingURL=index.js.map