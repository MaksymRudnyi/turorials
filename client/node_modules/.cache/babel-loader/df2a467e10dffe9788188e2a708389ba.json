{"ast":null,"code":"var is = require('type-is');\n\nvar Busboy = require('busboy');\n\nvar extend = require('xtend');\n\nvar onFinished = require('on-finished');\n\nvar appendField = require('append-field');\n\nvar Counter = require('./counter');\n\nvar MulterError = require('./multer-error');\n\nvar FileAppender = require('./file-appender');\n\nvar removeUploadedFiles = require('./remove-uploaded-files');\n\nfunction drainStream(stream) {\n  stream.on('readable', stream.read.bind(stream));\n}\n\nfunction makeMiddleware(setup) {\n  return function multerMiddleware(req, res, next) {\n    if (!is(req, ['multipart'])) return next();\n    var options = setup();\n    var limits = options.limits;\n    var storage = options.storage;\n    var fileFilter = options.fileFilter;\n    var fileStrategy = options.fileStrategy;\n    var preservePath = options.preservePath;\n    req.body = Object.create(null);\n    var busboy;\n\n    try {\n      busboy = new Busboy({\n        headers: req.headers,\n        limits: limits,\n        preservePath: preservePath\n      });\n    } catch (err) {\n      return next(err);\n    }\n\n    var appender = new FileAppender(fileStrategy, req);\n    var isDone = false;\n    var readFinished = false;\n    var errorOccured = false;\n    var pendingWrites = new Counter();\n    var uploadedFiles = [];\n\n    function done(err) {\n      if (isDone) return;\n      isDone = true;\n      req.unpipe(busboy);\n      drainStream(req);\n      busboy.removeAllListeners();\n      onFinished(req, function () {\n        next(err);\n      });\n    }\n\n    function indicateDone() {\n      if (readFinished && pendingWrites.isZero() && !errorOccured) done();\n    }\n\n    function abortWithError(uploadError) {\n      if (errorOccured) return;\n      errorOccured = true;\n      pendingWrites.onceZero(function () {\n        function remove(file, cb) {\n          storage._removeFile(req, file, cb);\n        }\n\n        removeUploadedFiles(uploadedFiles, remove, function (err, storageErrors) {\n          if (err) return done(err);\n          uploadError.storageErrors = storageErrors;\n          done(uploadError);\n        });\n      });\n    }\n\n    function abortWithCode(code, optionalField) {\n      abortWithError(new MulterError(code, optionalField));\n    } // handle text field data\n\n\n    busboy.on('field', function (fieldname, value, fieldnameTruncated, valueTruncated) {\n      if (fieldnameTruncated) return abortWithCode('LIMIT_FIELD_KEY');\n      if (valueTruncated) return abortWithCode('LIMIT_FIELD_VALUE', fieldname); // Work around bug in Busboy (https://github.com/mscdex/busboy/issues/6)\n\n      if (limits && limits.hasOwnProperty('fieldNameSize')) {\n        if (fieldname.length > limits.fieldNameSize) return abortWithCode('LIMIT_FIELD_KEY');\n      }\n\n      appendField(req.body, fieldname, value);\n    }); // handle files\n\n    busboy.on('file', function (fieldname, fileStream, filename, encoding, mimetype) {\n      // don't attach to the files object, if there is no file\n      if (!filename) return fileStream.resume(); // Work around bug in Busboy (https://github.com/mscdex/busboy/issues/6)\n\n      if (limits && limits.hasOwnProperty('fieldNameSize')) {\n        if (fieldname.length > limits.fieldNameSize) return abortWithCode('LIMIT_FIELD_KEY');\n      }\n\n      var file = {\n        fieldname: fieldname,\n        originalname: filename,\n        encoding: encoding,\n        mimetype: mimetype\n      };\n      var placeholder = appender.insertPlaceholder(file);\n      fileFilter(req, file, function (err, includeFile) {\n        if (err) {\n          appender.removePlaceholder(placeholder);\n          return abortWithError(err);\n        }\n\n        if (!includeFile) {\n          appender.removePlaceholder(placeholder);\n          return fileStream.resume();\n        }\n\n        var aborting = false;\n        pendingWrites.increment();\n        Object.defineProperty(file, 'stream', {\n          configurable: true,\n          enumerable: false,\n          value: fileStream\n        });\n        fileStream.on('error', function (err) {\n          pendingWrites.decrement();\n          abortWithError(err);\n        });\n        fileStream.on('limit', function () {\n          aborting = true;\n          abortWithCode('LIMIT_FILE_SIZE', fieldname);\n        });\n\n        storage._handleFile(req, file, function (err, info) {\n          if (aborting) {\n            appender.removePlaceholder(placeholder);\n            uploadedFiles.push(extend(file, info));\n            return pendingWrites.decrement();\n          }\n\n          if (err) {\n            appender.removePlaceholder(placeholder);\n            pendingWrites.decrement();\n            return abortWithError(err);\n          }\n\n          var fileInfo = extend(file, info);\n          appender.replacePlaceholder(placeholder, fileInfo);\n          uploadedFiles.push(fileInfo);\n          pendingWrites.decrement();\n          indicateDone();\n        });\n      });\n    });\n    busboy.on('error', function (err) {\n      abortWithError(err);\n    });\n    busboy.on('partsLimit', function () {\n      abortWithCode('LIMIT_PART_COUNT');\n    });\n    busboy.on('filesLimit', function () {\n      abortWithCode('LIMIT_FILE_COUNT');\n    });\n    busboy.on('fieldsLimit', function () {\n      abortWithCode('LIMIT_FIELD_COUNT');\n    });\n    busboy.on('finish', function () {\n      readFinished = true;\n      indicateDone();\n    });\n    req.pipe(busboy);\n  };\n}\n\nmodule.exports = makeMiddleware;","map":{"version":3,"names":["is","require","Busboy","extend","onFinished","appendField","Counter","MulterError","FileAppender","removeUploadedFiles","drainStream","stream","on","read","bind","makeMiddleware","setup","multerMiddleware","req","res","next","options","limits","storage","fileFilter","fileStrategy","preservePath","body","Object","create","busboy","headers","err","appender","isDone","readFinished","errorOccured","pendingWrites","uploadedFiles","done","unpipe","removeAllListeners","indicateDone","isZero","abortWithError","uploadError","onceZero","remove","file","cb","_removeFile","storageErrors","abortWithCode","code","optionalField","fieldname","value","fieldnameTruncated","valueTruncated","hasOwnProperty","length","fieldNameSize","fileStream","filename","encoding","mimetype","resume","originalname","placeholder","insertPlaceholder","includeFile","removePlaceholder","aborting","increment","defineProperty","configurable","enumerable","decrement","_handleFile","info","push","fileInfo","replacePlaceholder","pipe","module","exports"],"sources":["C:/Users/apinto2/Desktop/teswordtomd/12 setembro/UPLOAD 9/turorials/server/node_modules/multer/lib/make-middleware.js"],"sourcesContent":["var is = require('type-is')\nvar Busboy = require('busboy')\nvar extend = require('xtend')\nvar onFinished = require('on-finished')\nvar appendField = require('append-field')\n\nvar Counter = require('./counter')\nvar MulterError = require('./multer-error')\nvar FileAppender = require('./file-appender')\nvar removeUploadedFiles = require('./remove-uploaded-files')\n\nfunction drainStream (stream) {\n  stream.on('readable', stream.read.bind(stream))\n}\n\nfunction makeMiddleware (setup) {\n  return function multerMiddleware (req, res, next) {\n    if (!is(req, ['multipart'])) return next()\n\n    var options = setup()\n\n    var limits = options.limits\n    var storage = options.storage\n    var fileFilter = options.fileFilter\n    var fileStrategy = options.fileStrategy\n    var preservePath = options.preservePath\n\n    req.body = Object.create(null)\n\n    var busboy\n\n    try {\n      busboy = new Busboy({ headers: req.headers, limits: limits, preservePath: preservePath })\n    } catch (err) {\n      return next(err)\n    }\n\n    var appender = new FileAppender(fileStrategy, req)\n    var isDone = false\n    var readFinished = false\n    var errorOccured = false\n    var pendingWrites = new Counter()\n    var uploadedFiles = []\n\n    function done (err) {\n      if (isDone) return\n      isDone = true\n\n      req.unpipe(busboy)\n      drainStream(req)\n      busboy.removeAllListeners()\n\n      onFinished(req, function () { next(err) })\n    }\n\n    function indicateDone () {\n      if (readFinished && pendingWrites.isZero() && !errorOccured) done()\n    }\n\n    function abortWithError (uploadError) {\n      if (errorOccured) return\n      errorOccured = true\n\n      pendingWrites.onceZero(function () {\n        function remove (file, cb) {\n          storage._removeFile(req, file, cb)\n        }\n\n        removeUploadedFiles(uploadedFiles, remove, function (err, storageErrors) {\n          if (err) return done(err)\n\n          uploadError.storageErrors = storageErrors\n          done(uploadError)\n        })\n      })\n    }\n\n    function abortWithCode (code, optionalField) {\n      abortWithError(new MulterError(code, optionalField))\n    }\n\n    // handle text field data\n    busboy.on('field', function (fieldname, value, fieldnameTruncated, valueTruncated) {\n      if (fieldnameTruncated) return abortWithCode('LIMIT_FIELD_KEY')\n      if (valueTruncated) return abortWithCode('LIMIT_FIELD_VALUE', fieldname)\n\n      // Work around bug in Busboy (https://github.com/mscdex/busboy/issues/6)\n      if (limits && limits.hasOwnProperty('fieldNameSize')) {\n        if (fieldname.length > limits.fieldNameSize) return abortWithCode('LIMIT_FIELD_KEY')\n      }\n\n      appendField(req.body, fieldname, value)\n    })\n\n    // handle files\n    busboy.on('file', function (fieldname, fileStream, filename, encoding, mimetype) {\n      // don't attach to the files object, if there is no file\n      if (!filename) return fileStream.resume()\n\n      // Work around bug in Busboy (https://github.com/mscdex/busboy/issues/6)\n      if (limits && limits.hasOwnProperty('fieldNameSize')) {\n        if (fieldname.length > limits.fieldNameSize) return abortWithCode('LIMIT_FIELD_KEY')\n      }\n\n      var file = {\n        fieldname: fieldname,\n        originalname: filename,\n        encoding: encoding,\n        mimetype: mimetype\n      }\n\n      var placeholder = appender.insertPlaceholder(file)\n\n      fileFilter(req, file, function (err, includeFile) {\n        if (err) {\n          appender.removePlaceholder(placeholder)\n          return abortWithError(err)\n        }\n\n        if (!includeFile) {\n          appender.removePlaceholder(placeholder)\n          return fileStream.resume()\n        }\n\n        var aborting = false\n        pendingWrites.increment()\n\n        Object.defineProperty(file, 'stream', {\n          configurable: true,\n          enumerable: false,\n          value: fileStream\n        })\n\n        fileStream.on('error', function (err) {\n          pendingWrites.decrement()\n          abortWithError(err)\n        })\n\n        fileStream.on('limit', function () {\n          aborting = true\n          abortWithCode('LIMIT_FILE_SIZE', fieldname)\n        })\n\n        storage._handleFile(req, file, function (err, info) {\n          if (aborting) {\n            appender.removePlaceholder(placeholder)\n            uploadedFiles.push(extend(file, info))\n            return pendingWrites.decrement()\n          }\n\n          if (err) {\n            appender.removePlaceholder(placeholder)\n            pendingWrites.decrement()\n            return abortWithError(err)\n          }\n\n          var fileInfo = extend(file, info)\n\n          appender.replacePlaceholder(placeholder, fileInfo)\n          uploadedFiles.push(fileInfo)\n          pendingWrites.decrement()\n          indicateDone()\n        })\n      })\n    })\n\n    busboy.on('error', function (err) { abortWithError(err) })\n    busboy.on('partsLimit', function () { abortWithCode('LIMIT_PART_COUNT') })\n    busboy.on('filesLimit', function () { abortWithCode('LIMIT_FILE_COUNT') })\n    busboy.on('fieldsLimit', function () { abortWithCode('LIMIT_FIELD_COUNT') })\n    busboy.on('finish', function () {\n      readFinished = true\n      indicateDone()\n    })\n\n    req.pipe(busboy)\n  }\n}\n\nmodule.exports = makeMiddleware\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}